---
interface Props {
  id?: string;
  name?: string;
  accept?: string; // ex: "application/pdf"
  maxSizeMB?: number; // ex: 25
  multiple?: boolean;
  label?: string; // ex: "Importer un dossier"
}

const {
  id = "upload-file",
  name = "file",
  accept = "application/pdf",
  maxSizeMB = 25,
  multiple = false,
  label = "Importer un dossier",
} = Astro.props;
---

<section
  class="upload"
  aria-labelledby="upload-title"
  data-input-id={id}
  data-accept={accept}
  data-max-bytes={(maxSizeMB * 1024 * 1024).toString()}
  data-multiple={multiple ? "true" : "false"}
>
  <div class="upload__inner">
    <h3 id="upload-title" class="upload__title">D√©poser votre dossier</h3>

    <!-- input fichier (toujours pr√©sent) -->
    <input
      id={id}
      name={name}
      class="visually-hidden"
      type="file"
      accept={accept}
      {...multiple ? { multiple: true } : {}}
      aria-describedby="upload-help upload-constraints upload-status"
    />

    <!-- Dropzone (contient le bouton) -->
    <div
      id="dropzone"
      class="dropzone"
      role="button"
      tabindex="0"
      aria-describedby="upload-help upload-constraints"
    >
      <div class="dropzone__content">
        <div class="dropzone__icon" aria-hidden="true">üìÅ</div>
        <p class="dropzone__text">Glissez et d√©posez votre dossier ici</p>
        <p class="dropzone__or">ou</p>
        <label class="btn" for={id} data-variant="secondary">{label}</label>
      </div>
    </div>

    <p id="upload-constraints" class="upload__constraints">
      Poids maximal du dossier : {maxSizeMB} Mo ‚Ä¢ Format accept√© : PDF
    </p>

    <div id="upload-status" class="upload__status" aria-live="polite"></div>
    <p id="upload-help" class="visually-hidden">
      Utilisez le bouton pour choisir un fichier, ou glissez-d√©posez un fichier
      dans la zone (la zone de d√©p√¥t n‚Äôest visible qu‚Äô√† partir de 992 px).
    </p>
  </div>

  <script is:inline>
    (() => {
      const root = document.currentScript.closest(".upload");
      const ACCEPT = root.dataset.accept || "";
      const MAX_BYTES = parseInt(root.dataset.maxBytes || "0", 10);
      const IS_MULTIPLE = root.dataset.multiple === "true";

      const input = root.querySelector('input[type="file"]');
      const dz = root.querySelector("#dropzone");
      const status = root.querySelector("#upload-status");

      const label = dz.querySelector("label");
      if (label) {
        label.addEventListener("click", (e) => {
          // On laisse le comportement natif du label (ouvre la popup),
          // mais on emp√™che la remont√©e vers .dropzone.
          e.stopPropagation();
          // NE PAS faire input.click() ici !
        });
      }

      const prevent = (e) => {
        e.preventDefault();
        e.stopPropagation();
      };

      function validateFiles(fileList) {
        const files = Array.from(fileList || []);
        if (!files.length)
          return { ok: false, msg: "Aucun fichier s√©lectionn√©." };

        const typeOK = files.every(
          (f) =>
            !ACCEPT ||
            f.type === ACCEPT ||
            (ACCEPT === "application/pdf" &&
              f.name.toLowerCase().endsWith(".pdf"))
        );
        if (!typeOK)
          return {
            ok: false,
            msg: "Format invalide. Seuls les fichiers PDF sont accept√©s.",
          };

        const sizeOK = files.every((f) => f.size <= MAX_BYTES);
        if (!sizeOK)
          return {
            ok: false,
            msg: `Taille trop importante. Maximum ${Math.round(MAX_BYTES / 1024 / 1024)} Mo.`,
          };

        return {
          ok: true,
          msg: files
            .map(
              (f) =>
                `S√©lectionn√© : ${f.name} (${(f.size / 1024 / 1024).toFixed(2)} Mo)`
            )
            .join(" ‚Ä¢ "),
        };
      }

      function report({ ok, msg }) {
        status.textContent = msg;
        status.classList.toggle("is-error", !ok);
        status.classList.toggle("is-ok", ok);
      }

      // --- S√©lection via le bouton : on VALIDE SEULEMENT (pas de r√©assignation)
      input.addEventListener("change", () => {
        const res = validateFiles(input.files);
        report(res);
        // Optionnel: pour autoriser √† re-choisir le m√™me fichier juste apr√®s
        // si besoin : if (res.ok) input.value = '';
      });

      // --- DnD : on assigne au champ fichier SANS d√©clencher "change"
      function setFilesOnInput(files) {
        const dt = new DataTransfer();
        for (const f of files) dt.items.add(f);
        input.files = dt.files; // pas d'input.dispatchEvent('change')
        const res = validateFiles(files); // on valide/affiche manuellement
        report(res);
      }

      // Emp√™cher l‚Äôouverture du PDF dans le navigateur
      ["dragover", "drop"].forEach((ev) =>
        document.addEventListener(ev, prevent, false)
      );

      // Gestion DnD sur la zone
      ["dragenter", "dragover", "dragleave", "drop"].forEach((ev) =>
        dz.addEventListener(ev, prevent, false)
      );
      ["dragenter", "dragover"].forEach((ev) =>
        dz.addEventListener(ev, () => dz.classList.add("is-hover"))
      );
      ["dragleave", "drop"].forEach((ev) =>
        dz.addEventListener(ev, () => dz.classList.remove("is-hover"))
      );

      dz.addEventListener("drop", (e) => {
        const files = Array.from(e.dataTransfer?.files || []);
        if (!IS_MULTIPLE && files.length > 1) {
          report({
            ok: false,
            msg: "Vous ne pouvez d√©poser qu‚Äôun seul fichier.",
          });
          return;
        }
        setFilesOnInput(files);
      });

      // Accessibilit√© clavier / clic
      dz.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          input.click();
        }
      });
      dz.addEventListener("click", (e) => {
        // Si le clic vient du label (ou d‚Äôun enfant du label), on ne fait rien.
        if (e.target instanceof Element && e.target.closest("label")) return;
        input.click(); // clic ailleurs dans la zone => ouvrir
      });
    })();
  </script>

  <style lang="scss">
    .visually-hidden {
      position: absolute !important;
      width: 1px;
      height: 1px;
      overflow: hidden;
      clip: rect(0 0 0 0);
      white-space: nowrap;
      clip-path: inset(50%);
    }

    .upload {
      margin: 1.5rem 0;

      &__inner {
        display: grid;
        gap: 1rem;
      }
      &__title {
        font-size: 1.125rem;
        margin: 0;
      }
      &__constraints {
        font-size: 0.875rem;
        color: #486;
      }
      &__status {
        font-size: 0.9rem;
        min-height: 1.25rem;
        &.is-ok {
          color: #1b5e20;
        }
        &.is-error {
          color: #b00020;
        }
      }
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.875rem 1.25rem;
      border-radius: 0.75rem;
      border: 1px solid #0a7ea4;
      background: #fff;
      color: #0a7ea4;
      font-weight: 600;
      cursor: pointer;
      line-height: 1;
      text-decoration: none;
      &:hover {
        filter: brightness(1.05);
      }
      &:focus-visible {
        outline: 3px solid #82d0e6;
        outline-offset: 2px;
      }
    }

    /* Mobile : seul le bouton reste visible */
    .dropzone {
      display: block;
      .dropzone__content {
        display: grid;
        justify-items: center;
        gap: 0.25rem;
      }
      .dropzone__icon,
      .dropzone__text,
      .dropzone__or {
        display: none;
      }
      &:focus-visible {
        outline: 3px solid #82d0e6;
        outline-offset: 2px;
      }
    }

    /* ‚â• 992px : vraie dropzone */
    @media (min-width: 992px) {
      .dropzone {
        padding: 2rem;
        border: 2px dashed #82cbdc;
        border-radius: 1rem;
        background: #f6fbfd;
        .dropzone__icon,
        .dropzone__text,
        .dropzone__or {
          display: block;
        }
        .dropzone__icon {
          font-size: 1.75rem;
          margin-bottom: 0.25rem;
        }
        .dropzone__text {
          margin: 0;
          font-weight: 600;
        }
        .dropzone__or {
          margin: 0.25rem 0;
          opacity: 0.7;
        }
        &.is-hover {
          background: #eef8fb;
          border-color: #0a7ea4;
        }
      }
    }
  </style>
</section>
